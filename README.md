# Сервис по симуляции оплаты услуг ЖКХ

## Технологический стек

### Веб-фрейморки

* [Gin](https://github.com/gin-gonic/gin) - высокопроизводительный фреймворк, предназначенный для создания веб-приложений
* [gRPC](https://grpc.io/) - фреймворк для быстрой и бесперебойной связи микросервисов между собой

### Авторизация

* [jwt-go](https://github.com/golang-jwt/jwt) - Библиотека для генерации JWT
* [crypto](https://pkg.go.dev/golang.org/x/crypto) - Стандартная библиотека для шифрования

### Базы данных

* [SQLite](https://github.com/glebarez/go-sqlite) - встраиваемая легковестная СУБД (используется для хранения данных пользователей)
* [PostgeSQL](https://github.com/lib/pq) - мощная и популярная СУБД (используется для хранения счётов)
* [Migrate](https://github.com/golang-migrate/migrate) - библиотека для написания миграций баз данных

### Тестирование

* [Testify](https://github.com/stretchr/testify) - библиотека для эффективного написания тестов на Go

## Сборка и запуск

### 1. Клонирование репозитория с подмодулями

```bash
git clone --recurse-submodules https://github.com/iskanye/utilities-payment.git
cd utilities-payment
```

Если репозиторий был склонирован без подмодулей, выполните:

```bash
git submodule init
git submodule update
```

### 2. Сборка

Для сборки потребуется установленный [Docker](https://www.docker.com/).

**`ВАЖНО`**: Заранее при сборке установите значение параметров окружения `AUTH_SECRET`, `POSTGRES_USER`, `POSTGRES_PASSWORD` и `POSTGRES_DB` для корректной работы сервиса, например:

```bash
export AUTH_SECRET="SUPER-SECRET"
export POSTGRES_USER="postgres"
export POSTGRES_PASSWORD="postgres"
export POSTGRES_DB="postgres"
```

Или в среде Powershell:

```powershell
$Env:AUTH_SECRET="SUPER-SECRET"
$Env:POSTGRES_USER="postgres"
$Env:POSTGRES_PASSWORD="postgres"
$Env:POSTGRES_DB="postgres"
```

После выполните следующую команду для сборки сервисов:

```bash
docker compose build
```

### 3. Запуск

Для запуска сервисов выполните:

```bash
docker compose up
```

После запуска с сервисом можно будет работать по адресу `localhost:8080`

## Эндпоинты

### Регистрация и вход

#### `POST` `/users/register` - Регистрация пользователя

Тело запроса:

* `email` - email пользователя
* `password` - пароль пользователя

Ответ при успешной регистрации:

* `id` - id пользователя

Ответ при ошибке регистрации:

* `err` - текст ошибки

#### `POST` `/users/login` - Вход в систему

Тело запроса:

* `email` - email пользователя
* `password` - пароль пользователя

Ответ при успешном входе:

* `token` - уникальный токен пользователя

Ответ при ошибке входа:

* `err` - текст ошибки

### Работа со счетами

Для доступа к следующим эндпоинкам требуется добавить в заголовок запроса Bearer-token

#### `GET` `/bills/{id}` - Получение счёта по его ID

ID счёта береться из URI запроса

Ответ при успешном получении счёта:

* `ID` - ID счёта
* `Address` - адрес дома, на который выставлен счёт
* `Amount` - сумма счёта
* `UserID` - ID пользователя, которому назначен счёт
* `DueDate` - до какой даты надо заплатить счёт

Ответ при ошибке:

* `err` - текст ошибки

#### `GET` `/bills` - Получение счётов текущего пользователя

Ответ при успешном получении счётов:

* `bills` - список счётов данного пользователя

Каждый счёт состоит из следующих свойств:

* `ID` - ID счёта
* `Address` - адрес дома, на который выставлен счёт
* `Amount` - сумма счёта
* `UserID` - ID пользователя, которому назначен счёт
* `DueDate` - до какой даты надо заплатить счёт

Ответ при ошибке:

* `err` - текст ошибки

#### `POST` `/bills/pay` - Оплатить счёт

Тело запроса:

* `id` - ID счёта

При успешной оплате сервис ничего не возвращает

Ответ при ошибке:

* `err` - текст ошибки

### Админ панель

Для доступа к следующим эндпоинтам необходимы права админа

#### `POST` `/admin/bills` - Выставить счёт

Тело запроса:

* `address` - адрес, по которому будет выставлен счёёт
* `amount` - сумма счёта
* `user_id` - ID пользователя, которому выставляется счёт

Ответ при успешном входе:

* `id` - ID счёта

Ответ при ошибке:

* `err` - текст ошибки

#### `GET` `/admin/users` - Получить список всех пользователей

В случае успеха ответ представляет собой список пользователей со следующими свойствами:

* `ID` - ID пользователя
* `Email` - email пользователя
* `PassHash` - хеш пароля
* `IsAdmin` - является ли пользователь админом

Ответ при ошибке:

* `err` - текст ошибки
